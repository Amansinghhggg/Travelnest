<% layout('layouts/boilerplate') %>
<link rel="stylesheet" href="/css/showlisting.css">

<body>
  <div class="show-listing-container">
    <div class="listing-header">
      <h1><%= listing.title %></h1>
      <p class="listing-location">
        <i class="fa-solid fa-location-dot"></i> <%= listing.location %>, <%= listing.country %>
      </p>
    </div>

    <div class="listing-image-wrapper">
      <% if (currentUser && listing.owner.equals(currentUser._id)) { %>
        <div class="owner-actions">
          <a href="/listings/<%= listing._id %>/edit" class="btn btn-edit">
            <i class="fa-solid fa-pen-to-square"></i> Edit
          </a>
          <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST" style="margin: 0; display: inline;">
            <button type="submit" class="btn btn-delete" onclick="return confirm('Are you sure you want to delete this listing?')">
              <i class="fa-solid fa-trash"></i> Delete
            </button>
          </form>
        </div>
      <% } %>
      <img src="<%= listing.image.url %>" alt="<%= listing.title %>" class="listing-image">
    </div>

    <div class="listing-main">
      <div class="listing-content">
        <div class="listing-details">
          <h3>About this place</h3>
          <p><%= listing.description %></p>
        </div>

        <div class="host-info">
          <h5><strong>Hosted by</strong> <%= listing.owner.username %></h5>
          <p class="text-muted mb-0">Joined in 2024</p>
        </div>

        <div class="review-section" style="margin-top:40px;">
          <hr style="margin-bottom: 30px; border-color: #e0e0e0;">
          <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 20px;">
            <i class="fa-solid fa-star text-warning"></i> Reviews
          </h2>
          
          <% if (listing.reviews.length > 0) { %>
            <div class="rating-display-large mb-4" style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
              <span class="text-warning" style="font-size: 1.8rem; font-weight: 700;"><%= listing.averageRating %></span>
              <div>
                <div style="font-size: 1rem;">
                  <% for(let i = 0; i < Math.floor(listing.averageRating); i++) { %>
                    <i class="fa-solid fa-star text-warning"></i>
                  <% } %>
                  <% if (listing.averageRating % 1 >= 0.5) { %>
                    <i class="fa-solid fa-star-half-stroke text-warning"></i>
                  <% } %>
                  <% for(let i = Math.ceil(listing.averageRating); i < 5; i++) { %>
                    <i class="fa-regular fa-star text-warning"></i>
                  <% } %>
                </div>
                <small class="text-muted"><%= listing.reviews.length %> <%= listing.reviews.length === 1 ? 'review' : 'reviews' %></small>
              </div>
            </div>
          <% } %>
          
          <% if(listing.reviews.length === 0){ %>
            <div style="text-align: center; padding: 40px 20px; background: #f8f9fa; border-radius: 10px;">
              <i class="fa-regular fa-comment-dots" style="font-size: 3rem; color: #ccc; margin-bottom: 15px;"></i>
              <p class="text-muted" style="font-size: 1.1rem; margin: 0;">No Reviews Yet - Be The First Reviewer!</p>
            </div>
          <% } else { %>
            <div style="margin-top: 25px;">
              <%  for(let review of listing.reviews){ %>
                <div style="padding: 20px 0; border-bottom: 1px solid #e0e0e0; position: relative;">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 style="font-weight: 600; margin: 0; font-size: 1rem;">@<%= review.author ? review.author.username : 'Anonymous' %></h6>
                    <small class="text-muted" style="white-space: nowrap; font-size: 0.85rem;"><%= review.createdAt ? new Date(review.createdAt).toLocaleDateString() : 'Just now' %></small>
                  </div>
                  <div class="text-warning" style="font-size: 0.9rem; margin: 8px 0;">
                    <%= '★'.repeat(review.rating) %><span style="color: #ddd;"><%= '★'.repeat(5 - review.rating) %></span>
                  </div>
                  <p style="color: #666; margin: 0 0 12px 0; line-height: 1.6;"><%= review.comment %></p>
                  <% if (currentUser && review.author.equals(currentUser._id)) { %>
                    <form action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST" style="margin: 0; padding: 0; display: inline;">
                      <button type="submit" style="background: #ff385c; color: white; border: none; outline: none; padding: 6px 14px; border-radius: 6px; font-size: 0.8rem; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; box-shadow: none;" onmouseover="this.style.background='#e02f4f'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#ff385c'; this.style.transform='translateY(0)'" onclick="return confirm('Delete this review?')">
                        <i class="fa-solid fa-trash" style="font-size: 0.75rem;"></i>
                        <span>Delete</span>
                      </button>
                    </form>
                  <% } %>
                </div>
              <% } %>
            </div>
          <% } %>
        </div>
      </div>

      <div class="booking-section">
        <div class="booking-card">
          <div class="price">
            ₹<%= listing.price.toLocaleString("en-IN") %> <span>/ night</span>
          </div>

          <div class="date-inputs">
            <div class="date-input-group">
              <div class="input-wrapper">
                <label for="checkin">Check-in</label>
                <input type="date" id="checkin" name="checkin" required>
              </div>
              <div class="input-wrapper">
                <label for="checkout">Check-out</label>
                <input type="date" id="checkout" name="checkout" required>
              </div>
            </div>
            <div class="guests-input">
              <label for="guests">Guests</label>
              <input type="number" id="guests" name="guests" value="1" min="1" required>
            </div>
          </div>

          <button class="book-btn">Request to Book</button>
          <p class="booking-note">You won't be charged yet</p>

          <!-- <div class="price-breakdown">
            <div class="price-row">
              <span>₹<%= listing.price.toLocaleString("en-IN") %> x 5 nights</span>
              <span>₹<%= (listing.price * 5).toLocaleString("en-IN") %></span>
            </div>
            <div class="price-row">
              <span>Service fee</span>
              <span>₹1,500</span>
            </div>
            <div class="price-row total">
              <span>Total</span>
              <span>₹<%= (listing.price * 5 + 1500).toLocaleString("en-IN") %></span>
            </div>
          </div> -->
        </div>
      </div>
    </div>

    <!-- Write Review Section -->
    <% if(currentUser) { %>
      <div class="review-form-section" style="margin-top: 50px; background: #f8f9fa; padding: 30px; border-radius: 15px;">
        <h3 style="font-size: 1.8rem; font-weight: 700; margin-bottom: 25px;">Write a Review</h3>

        <form action="/listings/<%= listing._id %>/reviews" method="POST" class="review-form">
          <div class="mb-4">
            <label for="rating" style="font-weight: 600; margin-bottom: 10px; display: block;">Your Rating:</label>
            <div class="stars">
              <% for (let i = 5; i >= 1; i--) { %>
                <input type="radio" name="review[rating]" id="star-<%= i %>" value="<%= i %>" required>
                <label for="star-<%= i %>">★</label>
              <% } %>
            </div>
          </div>

          <div class="mb-4">
            <label for="comment" style="font-weight: 600; margin-bottom: 10px; display: block;">Your Review:</label>
            <textarea class="form-control" name="review[comment]" id="comment" rows="5" placeholder="Share your experience..." required style="border-radius: 10px; padding: 15px;"></textarea>
            <div class="invalid-feedback">Enter A Valid Description</div>
          </div>
          
          <button type="submit" class="btn btn-dark" style="padding: 12px 40px; border-radius: 8px; font-weight: 600;">Submit Review</button>
        </form>
      </div>
    <% } %>
  </div>

</body>
